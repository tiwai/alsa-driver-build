--- ../alsa-kernel/pci/bt87x.c	2014-06-23 12:51:03.890080685 +0200
+++ bt87x.c	2014-06-23 18:07:21.812034164 +0200
@@ -1,3 +1,12 @@
+#include "adriver.h"
+
+#if LINUX_VERSION_CODE < KERNEL_VERSION(3, 16, 0)
+#include <linux/atomic.h>
+#ifndef smp_mb__after_atomic
+#define smp_mb__after_atomic()	smp_mb__after_clear_bit()
+#endif
+#endif /* < 3.16.0 */
+
 /*
  * bt87x.c - Brooktree Bt878/Bt879 driver for ALSA
  *
@@ -850,14 +859,26 @@
 {
 	int i;
 	const struct pci_device_id *supported;
+	u16 subsystem_vendor, subsystem_device;
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 6, 13)
 	supported = pci_match_id(snd_bt87x_ids, pci);
+#else
+	supported = pci_match_device(snd_bt87x_ids, pci);
+#endif
 	if (supported && supported->driver_data > 0)
 		return supported->driver_data;
 
+#if LINUX_VERSION_CODE >= KERNEL_VERSION(2, 3, 0)
+	subsystem_vendor = pci->subsystem_vendor;
+	subsystem_device = pci->subsystem_device;
+#else
+	pci_read_config_word(pci, PCI_SUBSYSTEM_VENDOR_ID, &subsystem_vendor);
+	pci_read_config_word(pci, PCI_SUBSYSTEM_ID, &subsystem_device);
+#endif
 	for (i = 0; i < ARRAY_SIZE(blacklist); ++i)
-		if (blacklist[i].subvendor == pci->subsystem_vendor &&
-		    blacklist[i].subdevice == pci->subsystem_device) {
+		if (blacklist[i].subvendor == subsystem_vendor &&
+		    blacklist[i].subdevice == subsystem_device) {
 			dev_dbg(&pci->dev,
 				"card %#04x-%#04x:%#04x has no audio\n",
 				    pci->device, pci->subsystem_vendor, pci->subsystem_device);
@@ -865,7 +886,7 @@
 		}
 
 	dev_info(&pci->dev, "unknown card %#04x-%#04x:%#04x\n",
-		   pci->device, pci->subsystem_vendor, pci->subsystem_device);
+		   pci->device, subsystem_vendor, subsystem_device);
 	dev_info(&pci->dev, "please mail id, board name, and, "
 		   "if it works, the correct digital_rate option to "
 		   "<alsa-devel@alsa-project.org>\n");
@@ -993,3 +1014,5 @@
 
 module_init(alsa_card_bt87x_init)
 module_exit(alsa_card_bt87x_exit)
+
+EXPORT_NO_SYMBOLS;
